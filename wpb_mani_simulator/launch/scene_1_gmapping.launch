<?xml version="1.0"?>
<launch>
  <!-- 参数设置 -->
  <arg name="world_name" default="$(find wpb_mani_simulator)/worlds/scene_1.world"/>
  <arg name="paused" default="false"/>
  <arg name="use_sim_time" default="true"/>
  <arg name="gui" default="true"/>
  <arg name="recording" default="false"/>
  <arg name="debug" default="false"/>

  <!-- 设置使用仿真时间，这对Gazebo和Gmapping至关重要 -->
  <param name="use_sim_time" value="true"/>

  <!-- 启动Gazebo仿真环境 -->
  <include file="$(find gazebo_ros)/launch/empty_world.launch">
    <arg name="world_name" value="$(arg world_name)"/>
    <arg name="paused" value="$(arg paused)"/>
    <arg name="use_sim_time" value="$(arg use_sim_time)"/>
    <arg name="gui" value="$(arg gui)"/>
    <arg name="recording" value="$(arg recording)"/>
    <arg name="debug" value="$(arg debug)"/>
  </include>

  <!-- 生成桌子和箱子 -->
  <node name="table" pkg="gazebo_ros" type="spawn_model" args="-file $(find wpb_mani_simulator)/models/table_20cm.model -x 0.5 -y 3.8 -z 0 -Y 1.57 -urdf -model table" />

  <node name="box_1" pkg="gazebo_ros" type="spawn_model" args="-file $(find wpb_mani_simulator)/models/boxes/box_yellow.model -x 1.0 -y 3.91 -z 3.0 -Y 3.14159 -urdf -model box_1" />
  <node name="box_2" pkg="gazebo_ros" type="spawn_model" args="-file $(find wpb_mani_simulator)/models/boxes/box_yellow.model -x 0.7 -y 3.91 -z 3.0 -Y 3.14159 -urdf -model box_2" />
  <node name="box_3" pkg="gazebo_ros" type="spawn_model" args="-file $(find wpb_mani_simulator)/models/boxes/box_yellow.model -x 0.2 -y 3.91 -z 3.0 -Y 3.14159 -urdf -model box_3" />

  <node name="red_bin" pkg="gazebo_ros" type="spawn_model" args="-file $(find wpb_mani_simulator)/models/bins/red_bin.model -x -2.2 -y 0.12 -z 0.0 -Y 3.14159 -urdf -model red_bin" />
  <node name="green_bin" pkg="gazebo_ros" type="spawn_model" args="-file $(find wpb_mani_simulator)/models/bins/green_bin.model -x -2.2 -y 0.42 -z 0.0 -Y 3.14159 -urdf -model green_bin" />
  <node name="blue_bin" pkg="gazebo_ros" type="spawn_model" args="-file $(find wpb_mani_simulator)/models/bins/blue_bin.model -x -2.2 -y -0.18 -z 0.0 -Y 3.14159 -urdf -model blue_bin" />
  
  <!-- 在Gazebo中生成机器人 -->
  <param name="robot_description" command="$(find xacro)/xacro.py --inorder $(find wpb_mani_description)/urdf/wpb_mani.urdf.xacro" />
  <node name="spawn_urdf" pkg="gazebo_ros" type="spawn_model" args="-param robot_description -urdf -x 1.5 -y -2 -Y 1.5707 -model wpb_mani" />

  <!-- 加载机器人控制器 -->
  <include file="$(find wpb_mani_simulator)/launch/wpb_mani_controllers.launch"/>

  <!-- 运行激光雷达滤波器 -->
  <node pkg="wpb_mani_simulator" type="wpb_mani_sim_lidar_filter" name="wpb_mani_sim_lidar_filter">
    <param name="pub_topic" value="/scan"/>
  </node>

  <!-- 增强Gmapping配置 -->
  <node pkg="gmapping" type="slam_gmapping" name="slam_gmapping" output="screen">
    <remap from="scan" to="/scan"/>
    <param name="base_frame" value="base_footprint"/>
    <param name="odom_frame" value="odom"/>
    <param name="map_frame" value="map"/>
    <param name="map_update_interval" value="1.0"/>
    <param name="maxUrange" value="10.0"/>
    <param name="sigma" value="0.05"/>
    <param name="kernelSize" value="1"/>
    <param name="lstep" value="0.05"/>
    <param name="astep" value="0.05"/>
    <param name="iterations" value="5"/>
    <param name="lsigma" value="0.075"/>
    <param name="ogain" value="3.0"/>
    <param name="lskip" value="0"/>
    <param name="srr" value="0.01"/>
    <param name="srt" value="0.02"/>
    <param name="str" value="0.01"/>
    <param name="stt" value="0.02"/>
    <param name="linearUpdate" value="0.2"/>
    <param name="angularUpdate" value="0.1"/>
    <param name="temporalUpdate" value="0.5"/>
    <param name="resampleThreshold" value="0.5"/>
    <param name="particles" value="30"/>
    <param name="xmin" value="-20.0"/>
    <param name="ymin" value="-20.0"/>
    <param name="xmax" value="20.0"/>
    <param name="ymax" value="20.0"/>
    <param name="delta" value="0.05"/>
  </node>

  <!-- 启动机器人状态发布器 -->
  <node name="robot_state_publisher" pkg="robot_state_publisher" type="robot_state_publisher">
    <param name="publish_frequency" type="double" value="50.0" />
  </node>

  <!-- 关键修改：添加键盘控制节点（替换游戏手柄控制） -->
  <node name="teleop_keyboard" pkg="teleop_twist_keyboard" type="teleop_twist_keyboard.py" output="screen">
    <remap from="cmd_vel" to="/cmd_vel"/>
    <param name="speed" value="0.3"/>
    <param name="turn" value="0.5"/>
  </node>

  <!-- 启动RViz可视化 -->
  <arg name="model" default="$(find wpb_mani_description)/urdf/wpb_mani.urdf.xacro"/>
  <param name="robot_description" command="$(find xacro)/xacro.py $(arg model)" />
  <arg name="rvizconfig" default="$(find wpb_mani_simulator)/rviz/slam.rviz" />
  <node name="rviz" pkg="rviz" type="rviz" args="-d $(arg rvizconfig)" required="true" />

</launch>
